{{Notice | This guide is intended for maintaining non-core update sites by automating builds with [https://travis-ci.org/ Travis CI].<br>
* The [[How_to_upload_to_core_update_sites|core update sites]] are updated manually or by [[Jenkins]].
* Travis CI is useful because it can freely build any open source project with minimal effort.
}}
{{UpdateSites}}

= Requirements =
* An open-source project hosted on [[GitHub]]
* Logging in to [https://travis-ci.org/auth Travis CI] with your corresponding GitHub account
* [https://github.com/travis-ci/travis.rb#installation Travis command line tools]
* An [[Special:CreateAccount|account on this wiki]]
* An [[Special:ChangeUploadPassword|initialized upload password]]. ('''NOTE''' - ''not'' necessarily the same as your Wiki password)

= Additional resources =
* [https://docs.travis-ci.com/user/getting-started/ Travis CI user guide]

= Automatic Uploads via Travis CI =

Travis CI can be used to automatically build a repository in response to code changes. To ease the maintenance of ImageJ update sites, we can use Travis to automatically upload the latest version of a site. This is done by creating a <code>.travis.yml</code> file in your update site's GitHub repository that does the following:
# Create a fresh ImageJ.app
# Build the update site's repository and move the required artifacts (e.g. <code>.jars</code>) to their intended locations in the ImageJ.app
# Upload the local update site state to your Wiki update site

As a starting point you can copy the following <code>.travis.yml</code> :

<source lang="yaml">
language: java
sudo: false

cache:
  directories:
    - $HOME/.m2/

install:
  - mvn package

script:
  - ./.travis-deploy.sh

branches:
  only:
    - master
</source>

and this script <code>.travis-deploy.sh</code> :

<source lang="bash">
#!/usr/bin/env sh
set -e

# Define some variables
export USER="Username"
export UPDATE_SITE="Update_Site"

export IJ_PATH="$HOME/Fiji.app"
export URL="http://sites.imagej.net/$UPDATE_SITE/"
export IJ_LAUNCHER="$IJ_PATH/ImageJ-linux64"
export PATH="$IJ_PATH:$PATH"

# Install ImageJ
mkdir -p $IJ_PATH/
cd $HOME/
wget --no-check-certificate https://downloads.imagej.net/fiji/latest/fiji-linux64.zip
unzip fiji-linux64.zip

# Install the package
cd $TRAVIS_BUILD_DIR/
mvn clean install -Dimagej.app.directory=$IJ_PATH -Ddelete.other.versions=true

# Deploy the package
$IJ_LAUNCHER --update edit-update-site $UPDATE_SITE $URL "webdav:$USER:$WIKI_UPLOAD_PASS" .
$IJ_LAUNCHER --update upload-complete-site --force --force-shadow $UPDATE_SITE
</source>

Don't forget to replace 

<source>
export USER="Username"
export UPDATE_SITE="Update_Site"
</source>

by your informations.

== Encrypting your password ==

To upload to your wiki update site, you will need to provide Travis CI with a <code>WIKI_UPLOAD_PASS</code> environment variable, which should evaluate to the [[Special:ChangeUploadPassword|upload password]] of the Wiki account performing the upload. To do so securely, follow the instructions on the [https://docs.travis-ci.com/user/environment-variables/#Encrypting-Variables-Using-a-Public-Key encrypting environment variables].

Note that when you run:

<source lang="bash">
$ travis encrypt WIKI_UPLOAD_PASS=super_secret --add env.matrix
</source>

in your repository, the <code>.travis.yml</code> will automatically be updated appropriately. You can simply commit and push the changes.

== Non-Mavenized Files ==

Travis CI is capable of building many languages besides Java. If you cannot use Maven with an <code>imagej.app.directory</code> then you need to replace the following line of your <code>.travis.yml</code>:

<source lang="yaml">
  - mvn clean install -Dimagej.app.directory="$(pwd)" -Ddelete.other.versions=true
</source>

with a sequence of commands that will move your build artifacts to the appropriate <code>/jars</code> or <code>/plugins</code> directory, as appropriate for your update site.

This is also true if you have custom scripts, macros, etc... if these files are not present in the correct locations of the local ImageJ.app, they will appear to have been deleted.

= Caveats =

{{Warning | '''USE CAUTION HERE'''
# You are configuring Travis CI to upload the state of an ImageJ installation to your update site. The current working directory IS the ImageJ.app that will be uploaded. If your build artifacts are not located in the <code>jars</code> or <code>plugins</code> directory, or you don't manually copy scripts to the correct location, ImageJ will see these items as having been deleted—'''effectively removing all content from your update site.''' You can mitigate this danger by customizing your <code>bootstrap.js</code> to download your own update site into the base ImageJ.app; only changes to the update site state will be uploaded.
# By default—building the master branch of your repository—your update site will be updated with **every change** to the source code. Although we encourage the master branch to be "[[Development_Lifecycle#Phase_2:_On_master|release ready]]", a safer practice would be to configure Travis CI to [https://docs.travis-ci.com/user/customizing-the-build/#Building-Specific-Branches only build specific branches]—and set it to build [[Reproducible builds|release versions]] only—e.g. with a release version integration branch.
# Using the Maven-based <code>.travis.yml</code> as suggested implies that you are conforming to the managed dependencies of the parent pom.xml. If you are not staying up-to-date with the ImageJ and Fiji update sites (by using the latest ImageJ or Fiji [[Architecture#Bill_of_Materials|bill of materials]]) then this automation may break your own update site.
}}

= See Also =

* [[Travis|Travis use]]
