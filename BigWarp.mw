{{ComponentStats:sc.fiji:bigwarp_fiji}}Bigwarp is a tool for manual, interactive, landmark-based deformable image alignment. 
It uses the [[BigDataViewer]] for visualization and navigation, and uses a
[[wikipedia:Thin_plate_spline|Thin Plate Spline]] implemented
{{GitHub|org=saalfeldlab|repo=bigwarp|label=in Java}}
to build a deformation from point correspondences.

The interface enables landmark pair placement and displays the effects 
of the warp on-the-fly.

== Installation ==
Bigwarp comes with Fiji.
You can access it via ''Plugins {{arrow}} BigDataViewer {{arrow}} Big Warp'', or by modifying {{GitHub|org=saalfeldlab|repo=bigwarp|path=src/main/resources/scripts/bigwarp_fiji_demo.bsh|label=this example script}}.  If this is not visible in your installation, try updating Fiji with ''Help {{arrow}} Update Fiji.''

== Usage ==

Open two images in ImageJ, one ''moving'' and the other ''target'' and navigate to ''Plugins {{arrow}} BigDataViewer {{arrow}} Big Warp.'' A dialog will appear prompting selection of the moving and target images.

=== Getting Help ===
Press {{key press|F1}} at any time to open a help page with a listing of navigation and editing commands. 

=== Landmark point placement and display in the viewer ===

Landmark placements is done in ''Landmark mode'' which you enter by holding {{key press|Spacebar}}. Users place pairs of corresponding points on the moving and target images.  

The following table shows the available commands and keystrokes for landmark placement, warping. 
{| border="1" style="border-collapse:collapse;"
| style="padding: 5px;" | {{key press|T}}
| style="padding: 5px;" | Toggle between warped view and raw view or moving image.
|-
| style="padding: 5px;" | {{key press|Ctrl}}+{{key press|O}}
| style="padding: 5px;" | Open landmarks from saved file.
|-
| style="padding: 5px;" | {{key press|Ctrl}}+{{key press|S}}
| style="padding: 5px;" | Save current landmarks to a file.
|-
| style="padding: 5px;" | hold {{key press|Spacebar}}
| style="padding: 5px;" | Toggle ''Landmark mode'' 
|-
| style="padding: 5px;" | <''Landmark mode''>+{{key press|left-click}}
| style="padding: 5px;" | Clicking while in landmark mode adds a landmark point or selects and existing landmark.
|-
| style="padding: 5px;" | <''Landmark mode''>+{{key press|left-click}}+{{key press|drag}}
| style="padding: 5px;" | Clicking an existing point and dragging changes it's position. 
|-
| style="padding: 5px;" | <''Landmark mode''>+{{key press|Shift}}+{{key press|left-click}}+{{key press|drag}}
| style="padding: 5px;" | "Move" a point.  The initial click places a
landmark point for the moving image.  The release places a landmark
point for the target image.
|-
| style="padding: 5px;" | <''Landmark mode''>+{{key press|Ctrl}}+{{key press|left-click}}
| style="padding: 5px;" | "Pin" a point.  Add a landmark at the same location for both moving and target images.
|-
| style="padding: 5px;" | {{key press|Ctrl}} + {{key press|Z}}
| style="padding: 5px;" | Undo the last landmark point change.
|-
| style="padding: 5px;" | {{key press|Ctrl}} + {{key press|Y}}
| style="padding: 5px;" | Redo the last landmark point change.
|-
| style="padding: 5px;" | {{key press|V}}
| style="padding: 5px;" | Toggle point visibility in the viewer.
|-
| style="padding: 5px;" | {{key press|N}}
| style="padding: 5px;" | Toggle point name visibility in the viewer.
|}

=== Landmark selection and editing in the table ===

Some changes to landmarks can be done by interacting with the landmark table.

{| border="1" style="border-collapse:collapse;"
| style="padding: 5px;" | {{key press|left-click}}
| style="padding: 5px;" | Select row.
|-
| style="padding: 5px;" | {{key press|Ctrl}}+{{key press|left-click}}
| style="padding: 5px;" | Add row to selection.
|-
| style="padding: 5px;" | {{key press|Shift}}+{{key press|left-click}}
| style="padding: 5px;" | Select range of rows.
|-
| style="padding: 5px;" | {{key press|Esc}}
| style="padding: 5px;" | Deselect all rows.
|-
| style="padding: 5px;" | <''Landmark mode''>+{{key press|left-click}}
| style="padding: 5px;" | Removes one landmark.
|-
| style="padding: 5px;" | {{key press|right-click}} {{arrow}} Delete
| style="padding: 5px;" | Deletes a landmark pair (row in the table).
|-
| style="padding: 5px;" | {{key press|right-click}} {{arrow}} Delete all selected
| style="padding: 5px;" | Deletes all selected landmark pairs (row in the table).
|}

=== Notes on point addition and landmark pair selection ===

* Adding a new landmark pair selects that pair (row) in the table.
* If a row is "missing" a moving (target) landmark point, then it must be selected in order to add that missing point by clicking in the moving (target) viewer.  Then BigWarp will find the "next" row that is missing a moving (target) landmark, and select that row automatically.
* If the selected row is not missing a landmark, the next click will add a new landmark pair.
* If multiple rows are selected when a viewer is clicked, the result will be as though only the first row was selected.

=== Navigation and Visualization ===

Bigwarp inherits many image [[BigDataViewer#Basic_Navigation|navigation]], [[BigDataViewer#Adjusting_Brightness_and_Color|visualization]], and [[BigDataViewer#Grouping_Sources|grouping]] features with BigDataViewer, the details of which can be found on the [[BigDataViewer|BigDataViewer]] page
or on the help page.  BigWarp specific features are documented below.

The following table shows the available navigation commands using the mouse:

{| border="1" style="border-collapse:collapse;"
| style="padding: 5px;" | {{key press|Q}}
| style="padding: 5px;" | Align the non-active viewer with the active viewer. 
|-
| style="padding: 5px;" | {{key press|W}}
| style="padding: 5px;" | Align the active viewer with the non-active viewer.
|-
| style="padding: 5px;" | {{key press|E}}
| style="padding: 5px;" | Centers the active viewer to the nearest landmark (considers 3D when applicable).
|-
| style="padding: 5px;" | {{key press|Ctrl}}+{{key press|D}}
| style="padding: 5px;" | Centers the active viewer to the next landmark.
|-
| style="padding: 5px;" | {{key press|Ctrl}}+{{key press|Shift}}+{{key press|D}}
| style="padding: 5px;" | Centers the active viewer to the previous landmark.
|-
| style="padding: 5px;" | {{key press|R}}
| style="padding: 5px;" | Resets the active viewer.
|-
| style="padding: 5px;" | {{key press|U}}
| style="padding: 5px;" | Show warp visualization / grid dialog.
|-
| style="padding: 5px;" | {{key press|F6}}
| style="padding: 5px;" | Show moving image panel Visibility & and Grouping dialog.
|-
| style="padding: 5px;" | {{key press|F7}}
| style="padding: 5px;" | Show target image panel Visibility & and Grouping 
dialog.
|-
| style="padding: 5px;" | {{key press|Ctrl}}+{{key press|E}}
| style="padding: 5px;" | Export moving image as an ImagePlus.
|-
| style="padding: 5px;" | {{key press|Ctrl}}+{{key press|Shift}}+{{key press|E}}
| style="padding: 5px;" | Export moving image as a Virtual ImagePlus.
|}

=== Commands shared with BigDataViewer ===
* [[BigDataViewer#Displaying_Multiple_Sources|Displaying multiple stacks ("sources")]]
* [[BigDataViewer#Grouping_Sources|Grouping sources]]
* [[BigDataViewer#Adjusting_Brightness_and_Color|Adjusting brightness and color]]
* [[BigDataViewer#Bookmarking_Locations_and_Orientations|Bookmarking views (locations and orientations)]]
====Mouse navigation====
{| border="1" style="border-collapse:collapse;"
| style="padding: 5px;" | {{key press|left-click|drag}}
| style="padding: 5px;" | Rotate (pan and tilt) around the point where the mouse was clicked.
|-
| style="padding: 5px;" | {{key press|right-click|drag}} or {{key press|middle-click|drag}}
| style="padding: 5px;" | Translate in the XY-plane.
|-
| style="padding: 5px;" | {{key press|mouse-wheel}}
| style="padding: 5px;" | Move along the z-axis.
|-
| style="padding: 5px;" | {{key press|Cmd|mouse-wheel}} or {{key press|Shift|Ctrl|mouse-wheel}}
| style="padding: 5px;" | Zoom in and out.
|}
====Keyboard navigation====
{| border="1" style="border-collapse:collapse;"
| style="padding: 5px;" | {{key press|X}}, {{key press|Y}}, {{key press|Z}}
| style="padding: 5px;" | Select keyboard rotation axis.
|-
| style="padding: 5px;" | {{key press|Left}}, {{key press|Right}}
| style="padding: 5px;" | Rotate clockwise or counter-clockwise around the choosen rotation axis.
|-
| style="padding: 5px;" | {{key press|Up}}, {{key press|Down}}
| style="padding: 5px;" | Zoom in or out.
|-
| style="padding: 5px;" | {{key press|,}}, {{key press|.}}
| style="padding: 5px;" | Move forward or backward along the Z-axis.
|-
| style="padding: 5px;" | {{key press|Shift|X}}
| style="padding: 5px;" | Rotate to the ZY-plane of the current source. (Look along the X-axis of the current source.)
|-
| style="padding: 5px;" | {{key press|Shift|Y}} or {{key press|Shift|A}}
| style="padding: 5px;" | Rotate to the XZ-plane of the current source. (Look along the Y-axis of the current source.)
|-
| style="padding: 5px;" | {{key press|Shift|Z}}
| style="padding: 5px;" | Rotate to the XY-plane of the current source. (Look along the Z-axis of the current source.)
|-
| style="padding: 5px;" | {{key press|[}} or {{key press|N}}
| style="padding: 5px;" | Move to previous timepoint.
|-
| style="padding: 5px;" | {{key press|]}} or {{key press|M}}
| style="padding: 5px;" | Move to next timepoint.
|}


For all navigation commands you can hold {{key press|Shift}} to rotate and browse
10x faster, or hold {{key press|Ctrl}} to rotate and browse
10x slower.
For example, {{key press|Left}} rotates by
1° clockwise, while {{key press|Shift|Left}} rotates by
10°, and {{key press|Ctrl|Left}} rotates by
0.1°.

=== Import and Export ===

Landmarks can be exported and imported from plain text files using the drop down menu in the landmark table panel ( ''File {{arrow}} Export (Import) landmarks.'' )

[[Image:Bigwarp_export.png]]

The warped moving image can be exported as an in-memory or [http://imagej.net/docs/guide/146-8.html virtual] ImagePlus.
A virtual ImagePlus is generally faster to generate but slower to browse,
whereas an in-memory ImagePlus will be slower to generate but faster to browse.

The exported image will have the same dimensions as the target image.
''Note: Take care when exporting very large data sets as they can cause out-of-memory exceptions.''

[[Category:Plugins]]
[[Category:Visualization]]
[[Category:Transform]]
[[Category:Registration]]
